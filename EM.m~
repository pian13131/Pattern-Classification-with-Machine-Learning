function [e] = EM(D_BG,D_FG,calculatedImg,Apad,d,c)

load('Zig-Zag Pattern.txt');
[szBG, ~] = size(D_BG);
[szFG, ~] = size(D_FG);
py_BG = szBG/(szBG + szFG);
py_FG = 1 - py_BG;

[pi_BG, mu_BG, Sigma_BG] = calh(D_BG,d,c);
[pi_FG, mu_FG, Sigma_FG] = calh(D_FG,d,c);

calculatedImg = zeros(255, 270);

for i = 1 : 255
    for j = 1 : 260
        window = dct2(Apad(i:i+7, j:j+7), 8, 8);
        x(zigzag) = window;
        if py_FG*calp(x(1:d), mu_FG, Sigma_FG, pi_FG) > py_BG*calp(x(1:d), mu_BG, Sigma_BG, pi_BG)
            calculatedImg(i, j) = 1;
        end
    end
end

% Calculate the error for 3 kind of solution result
eB2F = 0;% the times that the back point was misclassified as front
eF2B = 0;
numB = 0;% the number of back points
numF = 0;

for i = 1 : 255
    for j = 1 : 270
        
        if correctImg(i, j) == 255
            numF = numF + 1;
        else
            numB = numB + 1;
        end
        
        if calculatedImg(i, j)==0 && correctImg(i, j)==255
            eF2B = eF2B + 1;
        end
        if calculatedImg(i, j)==1 && correctImg(i, j)==0
            eB2F = eB2F + 1;
        end
    end        
end

e = py_FG*eF2B/numF + py_BG*eB2F/numB;

end

function [pi, mu, Sigma] = calh(D,d,c)
%UNTITLED Summary of this function goes here
%   Detailed explanation goes here
[row, ~] = size(D);
H = zeros(c, row);
pi = rand(1,c);
pi = pi/(sum(pi));
mu = zeros(c, d);
sigma2 = cov(D);   % how to random sigma???;
sigma2 = diag(diag(sigma2));
Sigma = zeros(c,d,d);
for i = 1:c
   Sigma(i,:,:) = sigma2(1:d,1:d);
   mu(i,:) = random('Normal',mean(D(:,d)),0.001);
end
loop = 1;
for p = 1:loop
    for i = 1:row
       for j = 1:c
          H(j,i) = mvnpdf(D(i,1:d), mu(j,:), squeeze(Sigma(j,:,:)));
       end 
    end
    H = H.*pi';
    H = H./sum(H);

    mu_new = zeros(c, d);
    Sigma_new = zeros(c,d,d);
    pi_new = zeros(1,c);
    for j = 1:c
       mu_new(j,:) = sum(H(j,:)'.*D(:,1:d))/sum(H(j,:));
       pi_new(j) = mean(H(j,:));
       Sigma_new(j,:,:) = diag(sum(H(j,:)'.*(D(:,1:d) - mu(j,:)).^2)./sum(H(j,:)));
    end
    mu = mu_new;
    pi = pi_new;
    Sigma = Sigma_new;
    Sigma(Sigma==0) = 1e-10;
end
end

function [P] = calp(x,u,s,p)
%UNTITLED2 Summary of this function goes here
%   Detailed explanation goes here
P = 0;
for j = 1:8
    P = P + mvnpdf(x, u(j,:), squeeze(s(j,:,:)))*p(j);
end
end